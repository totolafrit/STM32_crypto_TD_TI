<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STM32 Secure Sensors</title>
  <link rel="stylesheet" href="/styles.css" />
</head>

<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <div class="brandLogo"></div>
        <div class="brandTxt">
          <div class="brandTitle">STM32 Secure Sensors</div>
          <div class="brandSub">ECC key exchange ‚Ä¢ AES-256-GCM</div>
        </div>
      </div>

      <div class="nav">
        <button class="navBtn active" data-view="home">
          <span class="navIco">‚åÇ</span>
          <span class="navLbl">Accueil</span>
        </button>

        <button class="navBtn" data-view="temp">
          <span class="navIco">üå°</span>
          <span class="navLbl">Temp</span>
        </button>

        <button class="navBtn" data-view="press">
          <span class="navIco">‚è≤</span>
          <span class="navLbl">Press</span>
        </button>

        <button class="navBtn" data-view="logs">
          <span class="navIco">‚â°</span>
          <span class="navLbl">Logs</span>
        </button>
      </div>

      <div class="sideCards">
        <div class="sideCard">
          <div class="k">Device</div>
          <div class="v" id="device">-</div>
        </div>

        <div class="sideCard">
          <div class="k">Date</div>
          <div class="v small" id="dateTxt">-</div>
        </div>

        <div class="sideCard">
          <div class="k">Statut</div>
          <div class="statusPill">
            <span class="dot" id="dot"></span>
            <span id="status">idle</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="topbar">
        <div>
          <div class="pageTitle" id="pageTitle">Dashboard</div>
          <div class="pageSub" id="pageSub">Supervision temps r√©el</div>
        </div>
      </header>

      <!-- VIEWS -->
      <section class="views">

        <!-- HOME -->
        <div class="view show" id="view-home">
          <div class="homeWrap">
            <div class="grid2">
              <!-- Temp Card -->
              <div class="card bigCard">
                <div class="cardHead">
                  <div>
                    <div class="cardTitle">Temp√©rature</div>
                    <div class="cardSub">Ambiante</div>
                  </div>
                  <div class="bigValue"><span id="tempBig">-</span><span class="unit">¬∞C</span></div>
                </div>

                <div class="contentRow">
                  <div class="ringWrap">
                    <svg class="ring" viewBox="0 0 120 120" aria-label="Temp ring">
                      <circle class="ringBg" cx="60" cy="60" r="46"></circle>
                      <circle class="ringFg ringTemp" id="ringTemp" cx="60" cy="60" r="46"></circle>
                    </svg>
                    <div class="ringCenter">
                      <div class="ringLabel">TEMP</div>
                      <div class="ringValue"><span id="tempCenter">-</span><span class="unit">¬∞C</span></div>
                    </div>
                  </div>

                  <div class="rightCol">
                    <div class="label">Niveau</div>
                    <div class="lvl">
                      <div class="lvlFill" id="lvlTemp"></div>
                    </div>

                    <div class="label">Historique (10)</div>
                    <div class="bars" id="barsTemp"></div>
                  </div>
                </div>
              </div>

              <!-- Pressure Card -->
              <div class="card bigCard">
                <div class="cardHead">
                  <div>
                    <div class="cardTitle">Pression</div>
                    <div class="cardSub">Atmosph√©rique</div>
                  </div>
                  <div class="bigValue"><span id="pressBig">-</span><span class="unit">hPa</span></div>
                </div>

                <div class="contentRow">
                  <div class="ringWrap">
                    <svg class="ring" viewBox="0 0 120 120" aria-label="Press ring">
                      <circle class="ringBg" cx="60" cy="60" r="46"></circle>
                      <circle class="ringFg ringPress" id="ringPress" cx="60" cy="60" r="46"></circle>
                    </svg>
                    <div class="ringCenter">
                      <div class="ringLabel">PRES</div>
                      <div class="ringValue"><span id="pressCenter">-</span><span class="unit">hPa</span></div>
                    </div>
                  </div>

                  <div class="rightCol">
                    <div class="label">Niveau</div>
                    <div class="lvl">
                      <div class="lvlFill" id="lvlPress"></div>
                    </div>

                    <div class="label">Historique (10)</div>
                    <div class="bars" id="barsPress"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- TEMP VIEW -->
        <div class="view" id="view-temp">
          <div class="single">
            <div class="card bigCard">
              <div class="cardHead">
                <div>
                  <div class="cardTitle">Temp√©rature</div>
                  <div class="cardSub">Vue d√©taill√©e</div>
                </div>
                <div class="bigValue"><span id="tempOnlyBig">-</span><span class="unit">¬∞C</span></div>
              </div>

              <div class="contentRow">
                <div class="ringWrap">
                  <svg class="ring" viewBox="0 0 120 120">
                    <circle class="ringBg" cx="60" cy="60" r="46"></circle>
                    <circle class="ringFg ringTemp" id="ringTemp2" cx="60" cy="60" r="46"></circle>
                  </svg>
                  <div class="ringCenter">
                    <div class="ringLabel">TEMP</div>
                    <div class="ringValue"><span id="tempOnlyCenter">-</span><span class="unit">¬∞C</span></div>
                  </div>
                </div>

                <div class="rightCol">
                  <div class="label">Niveau</div>
                  <div class="lvl">
                    <div class="lvlFill" id="lvlTemp2"></div>
                  </div>

                  <div class="label">Historique (10)</div>
                  <div class="bars bigBars" id="barsTemp2"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- PRESS VIEW -->
        <div class="view" id="view-press">
          <div class="single">
            <div class="card bigCard">
              <div class="cardHead">
                <div>
                  <div class="cardTitle">Pression</div>
                  <div class="cardSub">Vue d√©taill√©e</div>
                </div>
                <div class="bigValue"><span id="pressOnlyBig">-</span><span class="unit">hPa</span></div>
              </div>

              <div class="contentRow">
                <div class="ringWrap">
                  <svg class="ring" viewBox="0 0 120 120">
                    <circle class="ringBg" cx="60" cy="60" r="46"></circle>
                    <circle class="ringFg ringPress" id="ringPress2" cx="60" cy="60" r="46"></circle>
                  </svg>
                  <div class="ringCenter">
                    <div class="ringLabel">PRES</div>
                    <div class="ringValue"><span id="pressOnlyCenter">-</span><span class="unit">hPa</span></div>
                  </div>
                </div>

                <div class="rightCol">
                  <div class="label">Niveau</div>
                  <div class="lvl">
                    <div class="lvlFill" id="lvlPress2"></div>
                  </div>

                  <div class="label">Historique (10)</div>
                  <div class="bars bigBars" id="barsPress2"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- LOGS VIEW -->
        <div class="view" id="view-logs">
          <div class="single">
            <div class="card logCard">
              <div class="cardHead">
                <div>
                  <div class="cardTitle">Logs</div>
                  <div class="cardSub">Derni√®res trames</div>
                </div>
                <button class="btn" id="clearLogs">Clear</button>
              </div>

              <div class="logBox" id="log"></div>
              <div class="logHint">Affiche les 50 derni√®res lignes max.</div>
            </div>
          </div>
        </div>

      </section>
    </main>
  </div>

<script>
  // ---------------------------
  // UI navigation
  // ---------------------------
  const navBtns = document.querySelectorAll(".navBtn");
  const views = {
    home: document.getElementById("view-home"),
    temp: document.getElementById("view-temp"),
    press: document.getElementById("view-press"),
    logs: document.getElementById("view-logs"),
  };

  const pageTitle = document.getElementById("pageTitle");
  const pageSub = document.getElementById("pageSub");

  function setView(name){
    for (const k in views) views[k].classList.remove("show");
    views[name].classList.add("show");

    navBtns.forEach(b => b.classList.toggle("active", b.dataset.view === name));

    if (name === "home"){ pageTitle.textContent = "Dashboard"; pageSub.textContent = "Supervision temps r√©el"; }
    if (name === "temp"){ pageTitle.textContent = "Temp√©rature"; pageSub.textContent = "Mesure ambiante"; }
    if (name === "press"){ pageTitle.textContent = "Pression"; pageSub.textContent = "Mesure atmosph√©rique"; }
    if (name === "logs"){ pageTitle.textContent = "Logs"; pageSub.textContent = "Derni√®res trames"; }
  }

  navBtns.forEach(btn => btn.addEventListener("click", () => setView(btn.dataset.view)));

  // ---------------------------
  // Helpers
  // ---------------------------
  const dotEl = document.getElementById("dot");
  const statusEl = document.getElementById("status");
  const deviceEl = document.getElementById("device");
  const dateTxt = document.getElementById("dateTxt");

  const logEl = document.getElementById("log");
  const clearLogsBtn = document.getElementById("clearLogs");

  const MAX_LOG_LINES = 50;
  let logLines = [];

  function pushLog(line){
    const t = new Date().toLocaleTimeString();
    logLines.push(`[${t}] ${line}`);
    if (logLines.length > MAX_LOG_LINES) logLines = logLines.slice(-MAX_LOG_LINES);
    logEl.textContent = logLines.join("\n");
    logEl.scrollTop = logEl.scrollHeight;
  }

  clearLogsBtn?.addEventListener("click", () => {
    logLines = [];
    logEl.textContent = "";
  });

  function setStatus(s){
    statusEl.textContent = s ?? "idle";
    const st = String(s || "").toLowerCase();
    if (st.includes("error")) dotEl.style.background = "var(--bad)";
    else if (st.includes("running")) dotEl.style.background = "var(--good)";
    else if (st.includes("connected")) dotEl.style.background = "var(--warn)";
    else dotEl.style.background = "var(--muted)";
  }

  function fmtTs(ts){
    if (!ts) return "-";
    return new Date(ts * 1000).toLocaleString();
  }

  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

  // ---------------------------
  // Ring (SVG)
  // ---------------------------
  function setRing(circleEl, pct){
    const r = 46;
    const c = 2 * Math.PI * r;
    const dash = c * clamp(pct, 0, 1);
    circleEl.style.strokeDasharray = `${dash} ${c - dash}`;
  }

  // ---------------------------
  // History bars (10)
  // ---------------------------
  const HIST_MAX = 10;
  const tempHist = [];
  const pressHist = [];

  function pushHist(arr, v){
    arr.push(v);
    if (arr.length > HIST_MAX) arr.shift();
  }

  function renderBars(container, arr, min, max){
    container.innerHTML = "";
    const safeMax = Math.max(max, min + 1e-9);
    arr.forEach(v => {
      const pct = clamp((v - min) / (safeMax - min), 0, 1);
      const bar = document.createElement("div");
      bar.className = "barItem";
      bar.style.height = `${Math.round(10 + pct * 48)}px`; // un peu plus compact
      container.appendChild(bar);
    });
    for (let i = arr.length; i < HIST_MAX; i++){
      const ghost = document.createElement("div");
      ghost.className = "barItem ghost";
      ghost.style.height = "12px";
      container.appendChild(ghost);
    }
  }

  // ---------------------------
  // UI elements mapping
  // ---------------------------
  const tempBig = document.getElementById("tempBig");
  const tempCenter = document.getElementById("tempCenter");
  const pressBig = document.getElementById("pressBig");
  const pressCenter = document.getElementById("pressCenter");

  const tempOnlyBig = document.getElementById("tempOnlyBig");
  const tempOnlyCenter = document.getElementById("tempOnlyCenter");
  const pressOnlyBig = document.getElementById("pressOnlyBig");
  const pressOnlyCenter = document.getElementById("pressOnlyCenter");

  const ringTemp = document.getElementById("ringTemp");
  const ringPress = document.getElementById("ringPress");
  const ringTemp2 = document.getElementById("ringTemp2");
  const ringPress2 = document.getElementById("ringPress2");

  const lvlTemp = document.getElementById("lvlTemp");
  const lvlPress = document.getElementById("lvlPress");
  const lvlTemp2 = document.getElementById("lvlTemp2");
  const lvlPress2 = document.getElementById("lvlPress2");

  const barsTemp = document.getElementById("barsTemp");
  const barsPress = document.getElementById("barsPress");
  const barsTemp2 = document.getElementById("barsTemp2");
  const barsPress2 = document.getElementById("barsPress2");

  const TEMP_MIN = 0, TEMP_MAX = 50;
  const PRES_MIN = 950, PRES_MAX = 1050;

  function setTempUI(t){
    if (t === null || t === undefined || isNaN(t)) return;
    const t2 = Math.round(t * 100) / 100;

    tempBig.textContent = t2;
    tempCenter.textContent = t2;
    tempOnlyBig.textContent = t2;
    tempOnlyCenter.textContent = t2;

    const pct = clamp((t - TEMP_MIN) / (TEMP_MAX - TEMP_MIN), 0, 1);
    setRing(ringTemp, pct);
    setRing(ringTemp2, pct);

    lvlTemp.style.width = `${pct*100}%`;
    lvlTemp2.style.width = `${pct*100}%`;

    pushHist(tempHist, t);
    renderBars(barsTemp, tempHist, TEMP_MIN, TEMP_MAX);
    renderBars(barsTemp2, tempHist, TEMP_MIN, TEMP_MAX);
  }

  function setPressUI(p){
    if (p === null || p === undefined || isNaN(p)) return;
    const p2 = Math.round(p * 100) / 100;

    pressBig.textContent = p2;
    pressCenter.textContent = p2;
    pressOnlyBig.textContent = p2;
    pressOnlyCenter.textContent = p2;

    const pct = clamp((p - PRES_MIN) / (PRES_MAX - PRES_MIN), 0, 1);
    setRing(ringPress, pct);
    setRing(ringPress2, pct);

    lvlPress.style.width = `${pct*100}%`;
    lvlPress2.style.width = `${pct*100}%`;

    pushHist(pressHist, p);
    renderBars(barsPress, pressHist, PRES_MIN, PRES_MAX);
    renderBars(barsPress2, pressHist, PRES_MIN, PRES_MAX);
  }

  // ---------------------------
  // WebSocket
  // ---------------------------
  const ws = new WebSocket(`ws://${location.host}/ws`);

  ws.onopen = () => { pushLog("WS connected"); };
  ws.onclose = () => { pushLog("WS closed"); setStatus("ws_closed"); };
  ws.onerror = () => { pushLog("WS error"); setStatus("ws_error"); };

  ws.onmessage = (ev) => {
    const msg = JSON.parse(ev.data);

    if (msg.type === "state") {
      setStatus(msg.status);
      deviceEl.textContent = msg.deviceId ?? "-";
      dateTxt.textContent = fmtTs(msg.ts);

      if (msg.temp !== undefined) setTempUI(Number(msg.temp));
      if (msg.pressure !== undefined) setPressUI(Number(msg.pressure));

      pushLog("State loaded");
      return;
    }

    if (msg.type === "status") {
      setStatus(msg.status);
      pushLog(`Status: ${msg.status}`);
      return;
    }

    if (msg.type === "hello") {
      deviceEl.textContent = msg.deviceId ?? "-";
      pushLog(`Hello: ${msg.deviceId}`);
      return;
    }

    if (msg.type === "key_ok") {
      pushLog("Crypto: ECDH OK ‚Üí AES key derived");
      return;
    }

    if (msg.type === "data") {
      setStatus(msg.status ?? "running");
      deviceEl.textContent = msg.deviceId ?? "-";
      dateTxt.textContent = fmtTs(msg.ts);

      if (msg.temp !== undefined) setTempUI(Number(msg.temp));
      if (msg.pressure !== undefined) setPressUI(Number(msg.pressure));

      pushLog(`DATA temp=${msg.temp} pressure=${msg.pressure} ts=${msg.ts}`);
      return;
    }

    if (msg.type === "log") {
      pushLog(msg.msg);
      return;
    }
  };

  setInterval(() => { if (ws.readyState === 1) ws.send("ping"); }, 5000);
</script>
</body>
</html>
